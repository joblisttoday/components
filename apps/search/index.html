<!doctype html>
<html lang="en" joblist-layout>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>@joblist/components/search</title>
		<script type="module" src="../../src/index.js"></script>
		<script type="module">
			import { hashRouter } from "../../src/libs/router-hash.js";

			// Initialize components
			const $search = document.createElement("joblist-search");
			const $results = document.createElement("joblist-results");

			// Handle search events
			$search.addEventListener("search", ({ detail }) => {
				console.log("ðŸŽ¯ Search event received:", detail);
				// Always set results, even if arrays are empty - let the component handle the display
				$results.setAttribute("results", JSON.stringify(detail));

				// Update hash with search query for privacy-preserving URL sharing
				if (detail.query && detail.query.trim()) {
					hashRouter.setParams({
						query: detail.query,
						view: detail.searchType,
					});
				} else {
					// Clear hash when no query
					hashRouter.clearParams();
				}
			});

			// Handle hash changes (browser back/forward, direct URL changes)
			const handleRouteChange = (newParams, oldParams) => {
				console.log("ðŸ”„ Hash route changed:", newParams, "from:", oldParams);

				const { query = "", view = "", type = "" } = newParams;
				const currentQuery = $search.getAttribute("query") || "";
				const currentView = $search.getAttribute("search-type") || "";

				// Support new 'view' param; fallback to legacy 'type'
				const newView = view || type;

				// Only update if values actually changed to avoid infinite loops
				if (query !== currentQuery) {
					$search.setAttribute("query", query);
				}

				if (newView && newView !== currentView) {
					$search.setAttribute("search-type", newView);
				}

				// Trigger search if we have a query
				if (query && query.trim()) {
					// Let the search component handle the search
					$search.dispatchEvent(new CustomEvent("search-trigger"));
				} else if (!query) {
					// Clear results when no query
					$results.setAttribute(
						"results",
						JSON.stringify({
							companies: [],
							jobs: [],
							query: "",
							searchType: newView || "both",
							stats: { totalCompanies: 0, totalJobs: 0, total: 0 },
						}),
					);
				}
			};

			// Listen for hash changes
			hashRouter.onParamsChange(handleRouteChange);

			// Initialize with current hash params
			const initialParams = hashRouter.getParams();
			const { query = "", view = "", type = "" } = initialParams;

			if (query) {
				$search.setAttribute("query", query);
			}

			// Support new 'view' param; fallback to legacy 'type'
			const initialView = view || type;
			if (initialView) {
				$search.setAttribute("search-type", initialView);
			}

			document.querySelector("joblist-page-main").append($search, $results);
		</script>
	</head>
	<body>
		<joblist-layout>
			<joblist-menu show-favicon="true" show-default="true"></joblist-menu>
			<joblist-page>
				<joblist-page-header>
					<header>
						<h1><a href="./"> Search </a></h1>
					</header>
				</joblist-page-header>
				<joblist-page-main> </joblist-page-main>
			</joblist-page>
		</joblist-layout>
	</body>
</html>
