<!doctype html>
<html lang="en" joblist-layout>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>@joblist/components/map</title>
		<script type="module">
			import joblist from "../../src/index.js";
			import { hashRouter } from "../../src/libs/router-hash.js";
			const { duckDBSdk, mapSdk } = joblist;
			const { companiesToMapMarkers } = mapSdk;

			// Global variables
			let allCompanies = [];
			let allJobs = [];
			let allMarkers = [];
			let initialJobCountsByCompany = {};

			// Components
			const $search = document.createElement("joblist-search");
			const $map = document.createElement("joblist-map-list");
			const $results = document.createElement("joblist-results");

			// Initialize the application
			async function init() {
				// Load initial data with job counts
				await duckDBSdk.initialize();
				allCompanies = await duckDBSdk.getAllCompaniesWithJobs();
				console.log("allCompanies", allCompanies);
				
				// Load all jobs to get job counts for initial display
				allJobs = await duckDBSdk.getAllJobsData();
				console.log("allJobs count:", allJobs.length);
				
				// Aggregate job counts by company for initial display
				allJobs.forEach(job => {
					const companyId = job.company_id;
					if (companyId) {
						initialJobCountsByCompany[companyId] = (initialJobCountsByCompany[companyId] || 0) + 1;
					}
				});
				
				// Add job counts to all companies for initial map display
				const allCompaniesWithJobCounts = allCompanies.map(company => ({
					...company,
					total_jobs: initialJobCountsByCompany[company.id] || 0
				}));
				
				console.log("ðŸ“Š Initial job counts by company:", Object.keys(initialJobCountsByCompany).length, "companies with jobs");
				allMarkers = companiesToMapMarkers(allCompaniesWithJobCounts);
			}

			// Handle search events
			const handleSearch = async ({ detail }) => {
				const { companies, jobs: jobsInput, query, searchType } = detail;
				let jobs = jobsInput;
				
				// Update hash with search query for privacy-preserving URL sharing
				if (query && query.trim()) {
					hashRouter.updateParams({ 
						query: query, 
						view: searchType 
					});
				} else {
					// Clear hash when no query
					hashRouter.clearParams();
				}

				if (!query) {
					$map.setAttribute("markers", JSON.stringify(allMarkers));
					$map.removeAttribute("jobs");
				} else {
					// Ensure we have jobs for counting even if view=companies
					if ((!jobs || jobs.length === 0) && query && query.trim()) {
						try {
							jobs = await duckDBSdk.searchJobs(query);
						} catch (e) {
							jobs = [];
						}
					}

					// Compute job counts by company for current result set (if any)
					const jobCountsByCompany = {};
					(jobs || []).forEach(job => {
						const companyId = job.company_id;
						if (companyId) {
							jobCountsByCompany[companyId] = (jobCountsByCompany[companyId] || 0) + 1;
						}
					});

					// Build company sets
					const companiesFromCompanies = Array.isArray(companies) ? companies : [];
					const byId = new Map(allCompanies.map(c => [c.id, c]));
					const jobCompanyIds = new Set((jobs || []).map(j => j.company_id).filter(Boolean));
					const companiesFromJobs = Array.from(jobCompanyIds).map(id => byId.get(id)).filter(Boolean);

					let companiesBase = [];
					if (searchType === 'companies') {
						companiesBase = companiesFromCompanies;
					} else if (searchType === 'jobs') {
						companiesBase = companiesFromJobs;
					} else {
						// both: union of companies and job-derived companies
						const map = new Map();
						[...companiesFromCompanies, ...companiesFromJobs].forEach(c => { if (c) map.set(c.id, c); });
						companiesBase = Array.from(map.values());
					}

					// Attach job counts (if available) for marker sizing/info
					const companiesWithJobCounts = companiesBase.map(company => ({
						...company,
						total_jobs: jobCountsByCompany[company.id] || company.total_jobs || 0
					}));

					const itemMarkers = companiesToMapMarkers(companiesWithJobCounts);
					$map.setAttribute("markers", JSON.stringify(itemMarkers));
					if (jobs && jobs.length > 0) {
						$map.setAttribute("jobs", JSON.stringify(jobs));
					} else {
						$map.removeAttribute("jobs");
					}
				}
				
				if (!companies && !(jobs && jobs.length)) {
					$map.removeAttribute("markers");
					$map.removeAttribute("jobs");
				}
			};

			// Handle hash changes (browser back/forward, direct URL changes)
			const handleRouteChange = (newParams, oldParams) => {
				console.log("ðŸ”„ Hash route changed:", newParams, "from:", oldParams);
				
				const { query = "", view = "", type = "", latitude = "", longitude = "", zoom = "3" } = newParams;
				const currentQuery = $search.getAttribute("query") || "";
				const currentView = $search.getAttribute("search-type") || "";
				
				// Support new 'view' param; fallback to legacy 'type'
				const newView = view || type || "jobs";
				
				// Update map position if specified
				if (latitude) $map.setAttribute("latitude", latitude);
				if (longitude) $map.setAttribute("longitude", longitude);
				if (zoom) $map.setAttribute("zoom", zoom);
				
				// Only update if values actually changed to avoid infinite loops
				if (query !== currentQuery) {
					$search.setAttribute("query", query);
				}
				
				if (newView && newView !== currentView) {
					$search.setAttribute("search-type", newView);
				}
				
				// Trigger search if we have a query
				if (query && query.trim()) {
					// Let the search component handle the search
					$search.dispatchEvent(new CustomEvent('search-trigger'));
				} else if (!query) {
					// Reset to show all markers when no query
					$map.setAttribute("markers", JSON.stringify(allMarkers));
					$map.removeAttribute("jobs");
				}
			};

			// Initialize and setup
			(async () => {
				await init();
				
				// Setup components
				$search.addEventListener("search", handleSearch);
				$results.style.display = "none"; // Initially hidden
				
				// Handle job filtering events from map markers
				$map.addEventListener("job-filter", ({ detail }) => {
					console.log("ðŸŽ¯ Job filter event received:", detail);
					const { companyId, jobs, type } = detail;
					
					if (jobs.length > 0) {
						// Show filtered results
						$results.setAttribute("results", JSON.stringify({
							companies: [],
							jobs: jobs,
							query: `Company: ${companyId}`,
							searchType: "jobs",
							stats: {
								totalCompanies: 0,
								totalJobs: jobs.length,
								total: jobs.length
							}
						}));
						$results.style.display = "block";
					} else {
						$results.style.display = "none";
					}
				});

				// Listen for hash changes
				hashRouter.onParamsChange(handleRouteChange);

				// Initialize with current hash params
				const initialParams = hashRouter.getParams();
				const { query = "", view = "", type = "", latitude = "", longitude = "", zoom = "3" } = initialParams;
				
				// Setup initial attributes
				const initView = view || type || 'jobs';
				$search.setAttribute('search-type', initView);
				
				if (query) {
					$search.setAttribute("query", query);
				}
				
				$map.setAttribute("latitude", latitude || "");
				$map.setAttribute("longitude", longitude || "");
				$map.setAttribute("zoom", zoom);
				$map.setAttribute("origin", "https://joblist.today/{}");
				$map.setAttribute("markers", JSON.stringify(allMarkers));

				document.querySelector("joblist-page").append($search, $map, $results);
			})();
		</script>
	</head>
	<body>
		<joblist-layout>
			<joblist-menu show-favicon="true" show-default="true"></joblist-menu>
			<joblist-page full> </joblist-page>
		</joblist-layout>
	</body>
</html>
