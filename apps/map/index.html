<!doctype html>
<html lang="en" joblist-layout>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>@joblist/components/map</title>
		<script type="module">
			import joblist from "../../src/index.js";
			const { duckDBSdk, mapSdk } = joblist;
			const { companiesToMapMarkers } = mapSdk;

			(async ({ query = "", latitude = "", longitude = "", zoom = 3 }) => {
				// Update hash when search changes (for URL sharing without server logs)
				const updateHashParams = (params) => {
					const hashParams = new URLSearchParams();
					Object.entries(params).forEach(([key, value]) => {
						if (value) hashParams.set(key, value);
					});
					const newHash = hashParams.toString();
					window.location.hash = newHash;
				};

				const handleSearch = ({ detail }) => {
					const { companies, jobs, query } = detail;
					
					// Update hash with search query for privacy-preserving URL sharing
					if (query && query.trim()) {
						updateHashParams({ query: query, type: detail.searchType });
					} else {
						// Clear hash when no query
						window.location.hash = '';
					}
					if (!query) {
						$map.setAttribute("markers", JSON.stringify(allMarkers));
					} else if (query && companies) {
						// Aggregate job counts by company if jobs are available
						let companiesWithJobCounts = companies;
						if (jobs && jobs.length > 0) {
							console.log("ðŸ“ Aggregating job counts by company for map");
							
							// Create a map of company_id -> job count
							const jobCountsByCompany = {};
							jobs.forEach(job => {
								const companyId = job.company_id;
								if (companyId) {
									jobCountsByCompany[companyId] = (jobCountsByCompany[companyId] || 0) + 1;
								}
							});
							
							console.log("ðŸ“Š Job counts by company:", jobCountsByCompany);
							
							// Add job counts to companies for map display
							companiesWithJobCounts = companies.map(company => ({
								...company,
								total_jobs: jobCountsByCompany[company.id] || 0
							}));
							
							console.log("ðŸ¢ Companies with job counts:", companiesWithJobCounts.map(c => ({ id: c.id, total_jobs: c.total_jobs })));
						}
						
						// Convert companies to map markers (now with job counts)
						const itemMarkers = companiesToMapMarkers(companiesWithJobCounts);
						console.log("ðŸ—ºï¸ Map markers with job counts:", itemMarkers);
						$map.setAttribute("markers", JSON.stringify(itemMarkers));
						
						// Store jobs data for potential filtering
						if (jobs && jobs.length > 0) {
							$map.setAttribute("jobs", JSON.stringify(jobs));
						}
					} else if (!companies) {
						$map.removeAttribute("markers");
						$map.removeAttribute("jobs");
					}
				};
				// Load initial data with job counts
				await duckDBSdk.initialize();
				const allCompanies = await duckDBSdk.getAllCompaniesWithJobs();
				console.log("allCompanies", allCompanies);
				
				// Load all jobs to get job counts for initial display
				const allJobs = await duckDBSdk.getAllJobsData();
				console.log("allJobs count:", allJobs.length);
				
				// Aggregate job counts by company for initial display
				const initialJobCountsByCompany = {};
				allJobs.forEach(job => {
					const companyId = job.company_id;
					if (companyId) {
						initialJobCountsByCompany[companyId] = (initialJobCountsByCompany[companyId] || 0) + 1;
					}
				});
				
				// Add job counts to all companies for initial map display
				const allCompaniesWithJobCounts = allCompanies.map(company => ({
					...company,
					total_jobs: initialJobCountsByCompany[company.id] || 0
				}));
				
				console.log("ðŸ“Š Initial job counts by company:", Object.keys(initialJobCountsByCompany).length, "companies with jobs");
				const allMarkers = companiesToMapMarkers(allCompaniesWithJobCounts);

				/* apply attributes to elements */
				const $search = document.createElement("joblist-search");
				$search.addEventListener("search", handleSearch);
				if (query) {
					$search.setAttribute("query", query);
				}

				const $map = document.createElement("joblist-map-list");
				$map.setAttribute("latitude", latitude);
				$map.setAttribute("longitude", longitude);
				$map.setAttribute("zoom", zoom);
				$map.setAttribute("origin", "https://joblist.today/{}");
				$map.setAttribute("markers", JSON.stringify(allMarkers));
				
				// Create results container for job filtering
				const $results = document.createElement("joblist-results");
				$results.style.display = "none"; // Initially hidden
				
				// Handle job filtering events from map markers
				$map.addEventListener("job-filter", ({ detail }) => {
					console.log("ðŸŽ¯ Job filter event received:", detail);
					const { companyId, jobs, type } = detail;
					
					if (jobs.length > 0) {
						// Show filtered results
						$results.setAttribute("results", JSON.stringify({
							companies: [],
							jobs: jobs,
							query: `Company: ${companyId}`,
							searchType: "jobs",
							stats: {
								totalCompanies: 0,
								totalJobs: jobs.length,
								total: jobs.length
							}
						}));
						$results.style.display = "block";
					} else {
						$results.style.display = "none";
					}
				});

				document.querySelector("joblist-page").append($search, $map, $results);
			})(() => {
				// Parse parameters from hash (for privacy) instead of URL search params
				const hash = window.location.hash.slice(1); // Remove the '#'
				return Object.fromEntries(new URLSearchParams(hash));
			})();
		</script>
	</head>
	<body>
		<joblist-layout>
			<joblist-menu show-favicon="true" show-default="true"></joblist-menu>
			<joblist-page full> </joblist-page>
		</joblist-layout>
	</body>
</html>
